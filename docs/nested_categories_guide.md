# 二级分类使用指南

## 📖 概述

Kulawyer（酷律师）现已支持**二级分类**功能！你可以创建层级化的分类结构，让工具组织更加清晰。

## 🌳 分类层级结构

```
法律文书生成（一级分类）
├── 合同审查（二级分类）
├── 起诉状生成（二级分类）
└── 律师函撰写（二级分类）

案例检索（一级分类）
├── 判例分析（二级分类）
└── 法规检索（二级分类）
```

## 💡 功能特性

### ✅ 支持的功能

1. **层级展示**：分类页面自动展示父子关系
2. **面包屑导航**：二级分类页面显示完整路径
3. **智能计数**：工具计数自动更新
4. **循环检测**：防止创建循环引用（A → B → A）
5. **批量导入**：YAML/CSV 导入支持二级分类
6. **自动导出**：导出时保留完整层级关系

### 🚫 限制说明

- **最多支持两级**：一级分类 + 二级分类（不支持三级及以上）
- **同名规则**：同一父分类下的子分类名称必须唯一
- **删除保护**：删除父分类会自动删除所有子分类

## 📝 使用方法

### 方法 1: 管理后台创建

1. 访问 `/admin/categories/new`
2. 填写分类信息
3. 在"Parent Category"下拉框中选择父分类
4. 如果不选择父分类，则创建一级分类
5. 点击"Create Category"保存

**截图示例：**

```
┌─────────────────────────────────────┐
│ Parent Category (Optional)          │
│ ┌─────────────────────────────────┐ │
│ │ [无（一级分类）         ▼]      │ │
│ └─────────────────────────────────┘ │
│ 如果不选择父分类，该分类将成为一级分类 │
└─────────────────────────────────────┘
```

### 方法 2: YAML 批量导入

#### 语法格式

```yaml
categories:
  # 一级分类（不需要 parent 字段）
  - name: "法律文书生成"
    description: "智能生成各类法律文书"
  
  # 二级分类（添加 parent 字段）
  - name: "合同审查"
    description: "专业的合同审查工具"
    parent: "法律文书生成"
  
  - name: "起诉状生成"
    description: "快速生成各类起诉状"
    parent: "法律文书生成"
```

#### 导入步骤

```bash
# 1. 编辑 YAML 文件
vim db/data/tools.yml

# 2. 添加分类数据（先写一级，再写二级）

# 3. 导入数据
rake tools:import
```

#### ⚠️ 注意事项

1. **顺序很重要**：必须先定义父分类，再定义子分类
2. **父分类名称必须完全匹配**：大小写、标点符号都要一致
3. **如果父分类不存在**：导入会跳过该子分类并显示警告

### 方法 3: CSV 批量导入

#### CSV 格式

CSV 暂不支持 parent 字段。如需创建二级分类，请使用 YAML 格式或管理后台。

## 📊 完整示例

### 示例 1: 法律AI工具分类

```yaml
categories:
  # 一级分类
  - name: "法律文书生成"
    description: "智能生成各类法律文书，包括合同、起诉状、律师函等"
  
  - name: "案例检索"
    description: "快速检索法律案例和判例"
  
  - name: "合规审查"
    description: "企业合规风险评估工具"
  
  # 二级分类 - 法律文书生成
  - name: "合同审查"
    description: "智能合同审查与风险提示"
    parent: "法律文书生成"
  
  - name: "起诉状生成"
    description: "各类诉讼文书快速生成"
    parent: "法律文书生成"
  
  - name: "律师函撰写"
    description: "专业律师函生成工具"
    parent: "法律文书生成"
  
  # 二级分类 - 案例检索
  - name: "判例分析"
    description: "AI判例智能分析"
    parent: "案例检索"
  
  - name: "法规检索"
    description: "法律法规快速查询"
    parent: "案例检索"
  
  # 二级分类 - 合规审查
  - name: "尽职调查"
    description: "企业尽职调查工具"
    parent: "合规审查"

tools:
  - name: "法小兔"
    website_url: "https://faxiaotu.com"
    short_description: "智能法律文书生成工具"
    pricing_type: "Freemium"
    categories:
      - "合同审查"  # 使用二级分类
      - "起诉状生成"
  
  - name: "威科先行"
    website_url: "https://law.wkinfo.com.cn"
    short_description: "专业法律案例检索平台"
    pricing_type: "Paid"
    categories:
      - "判例分析"  # 使用二级分类
```

### 示例 2: 导入并验证

```bash
# 导入数据
$ rake tools:import

📂 正在读取文件: /path/to/db/data/tools.yml

📁 正在处理分类...
  ✅ 创建一级分类: 法律文书生成
  ✅ 创建一级分类: 案例检索
  ✅ 创建一级分类: 合规审查
  ✅ 创建二级分类: 合同审查 (父级: 法律文书生成)
  ✅ 创建二级分类: 起诉状生成 (父级: 法律文书生成)
  ✅ 创建二级分类: 律师函撰写 (父级: 法律文书生成)
  ✅ 创建二级分类: 判例分析 (父级: 案例检索)
  ✅ 创建二级分类: 法规检索 (父级: 案例检索)
  ✅ 创建二级分类: 尽职调查 (父级: 合规审查)

🔧 正在处理工具...
  ✅ 创建工具: 法小兔 (Freemium)
  ✅ 创建工具: 威科先行 (Paid)

============================================================
📊 导入统计:
  ✅ 成功: 2 个
  ⏭️  跳过: 0 个
  ❌ 失败: 0 个
  📦 总计: 2 个
============================================================

🎉 导入完成！
📈 当前数据库统计:
  - 分类数量: 9
  - 一级分类: 3
  - 二级分类: 6
  - 工具数量: 2
```

## 🎨 前端展示效果

### 1. 分类列表页（/categories）

```
┌─────────────────────────────────────────────────────┐
│ 法律文书生成                     12 工具            │
│   ├─ 合同审查                     5 工具             │
│   ├─ 起诉状生成                   4 工具             │
│   └─ 律师函撰写                   3 工具             │
│                                                       │
│ 案例检索                         8 工具              │
│   ├─ 判例分析                     5 工具             │
│   └─ 法规检索                     3 工具             │
└─────────────────────────────────────────────────────┘
```

### 2. 二级分类详情页（/categories/he-tong-shen-cha）

```
┌─────────────────────────────────────────────────────┐
│ 🏠 所有分类 > 法律文书生成 > 合同审查              │
├─────────────────────────────────────────────────────┤
│             合同审查                                 │
│        智能合同审查与风险提示                        │
│                                                       │
│        📦 5 tools    📁 0 subcategories             │
└─────────────────────────────────────────────────────┘
```

### 3. 父分类详情页（/categories/fa-lu-wen-shu）

```
┌─────────────────────────────────────────────────────┐
│             法律文书生成                             │
│    智能生成各类法律文书，包括合同、起诉状等          │
│                                                       │
│        📦 12 tools    📁 3 subcategories            │
├─────────────────────────────────────────────────────┤
│ 子分类                                               │
│                                                       │
│ ┌──────────────┐  ┌──────────────┐                 │
│ │ 合同审查      │  │ 起诉状生成    │                 │
│ │ 5 工具        │  │ 4 工具        │                 │
│ └──────────────┘  └──────────────┘                 │
└─────────────────────────────────────────────────────┘
```

## 🔧 高级功能

### 1. 获取分类层级信息

```ruby
category = Category.find_by(name: "合同审查")

# 判断是否为根分类
category.root?  # => false

# 判断是否有子分类
category.has_children?  # => false

# 获取父分类
category.parent  # => #<Category name: "法律文书生成">

# 获取所有祖先分类（从根到父）
category.ancestors  # => [#<Category name: "法律文书生成">]

# 获取完整路径
category.full_path  # => "法律文书生成 > 合同审查"
category.full_path(separator: ' / ')  # => "法律文书生成 / 合同审查"

# 获取层级深度
category.level  # => 1 (0=根分类, 1=二级分类)
```

### 2. 查询分类

```ruby
# 获取所有一级分类
Category.root_categories

# 获取所有二级分类
Category.child_categories

# 获取某个父分类的所有子分类
parent = Category.find_by(name: "法律文书生成")
parent.children
```

### 3. 工具关联

```ruby
tool = Tool.find_by(name: "法小兔")

# 工具可以同时关联多个分类（包括一级和二级）
tool.categories  # => [#<Category name: "合同审查">, #<Category name: "起诉状生成">]

# 判断工具是否属于某个分类或其子分类
def tool_in_category_tree?(tool, category)
  tool_category_ids = tool.categories.pluck(:id)
  category_tree_ids = [category.id] + category.descendants.pluck(:id)
  (tool_category_ids & category_tree_ids).any?
end
```

## ❓ 常见问题

### Q1: 可以创建三级分类吗？

**A:** 目前仅支持两级分类（一级 + 二级）。如需更深层级，建议重新规划分类结构。

### Q2: 如何将一级分类改为二级分类？

**A:** 在管理后台编辑该分类，选择一个父分类即可。

### Q3: 删除父分类会怎样？

**A:** 所有子分类也会被删除。删除前请确认。

### Q4: 导入时父分类不存在怎么办？

**A:** 系统会跳过该子分类，并显示警告信息。请先创建父分类。

### Q5: 工具应该关联父分类还是子分类？

**A:** **建议关联子分类**。这样工具会更精准地归类。用户浏览父分类时，会看到所有子分类的工具。

### Q6: 同名分类在不同父分类下可以吗？

**A:** 可以！例如：
```
法律文书生成
└── 合同模板

企业合规
└── 合同模板
```
这两个"合同模板"是不同的分类。

### Q7: 如何导出包含层级的分类数据？

**A:** 使用 `rake tools:export`，导出的 YAML 文件会自动包含 `parent` 字段。

## 📚 相关文档

- [工具批量导入指南](./tools_import_guide.md)
- [快速入门](./quick_start_tools.md)
- [YAML 模板和示例](../db/data/TEMPLATE_AND_EXAMPLES.yml)
- [数据管理文档](../db/data/README.md)

## 🎯 最佳实践

1. **合理规划层级**：一级分类用于大类，二级分类用于细分
2. **避免过度细分**：子分类不宜过多（建议每个父分类 3-8 个子分类）
3. **命名清晰**：避免使用模糊或重叠的名称
4. **先导一级，再导二级**：YAML 导入时遵循顺序
5. **定期导出备份**：使用 `rake tools:export` 备份分类数据

## 🚀 升级说明

如果你的项目是从旧版本升级的：

1. 数据库迁移已自动完成
2. 现有分类自动成为一级分类
3. 无需手动修改数据
4. 可以直接开始创建二级分类

---

**Kulawyer（酷律师）- 发现最佳法律AI工具** 🎉
